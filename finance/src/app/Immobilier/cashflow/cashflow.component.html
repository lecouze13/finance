<div class="simulateur-container">
  <section class="header-section">
    <h1>Simulateur Cashflow Immobilier</h1>
    <p class="subtitle">Calculez votre flux de trésorerie mensuel et évaluez la rentabilité de votre investissement locatif</p>
    <div class="export-actions">
      <app-export-buttons [exportData]="getExportData()" [showPrint]="true"></app-export-buttons>
    </div>
  </section>

  <div class="content-grid">
    <div class="form-section">
      <p-panel header="Revenus locatifs" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Loyer mensuel perçu</label>
            <p-inputNumber [(ngModel)]="loyerMensuel" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
      </p-panel>

      <p-panel header="Crédit immobilier" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Mensualité crédit</label>
            <p-inputNumber [(ngModel)]="mensualiteCredit" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
      </p-panel>

      <p-panel header="Charges mensuelles" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group">
            <label>Charges copropriété</label>
            <p-inputNumber [(ngModel)]="chargesCopro" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>

          <div class="form-group">
            <label>Taxe foncière (annuelle)</label>
            <p-inputNumber [(ngModel)]="taxeFonciere" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>

          <div class="form-group">
            <label>Assurance PNO</label>
            <p-inputNumber [(ngModel)]="assurancePNO" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>

          <div class="form-group">
            <label>Frais de gestion</label>
            <p-inputNumber [(ngModel)]="fraisGestion" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>

          <div class="form-group">
            <label>Autres charges</label>
            <p-inputNumber [(ngModel)]="autresCharges" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
      </p-panel>

      <p-panel header="Provisions" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group">
            <label>Vacance locative</label>
            <p-inputNumber [(ngModel)]="provisionVacance" suffix=" %"
                           [min]="0" [max]="20" (ngModelChange)="calculer()"></p-inputNumber>
          </div>

          <div class="form-group">
            <label>Travaux / Entretien</label>
            <p-inputNumber [(ngModel)]="provisionTravaux" suffix=" %"
                           [min]="0" [max]="20" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>

        <div class="help-box" style="margin-top: 1rem;">
          <h4><i class="pi pi-info-circle"></i> Provisions recommandées</h4>
          <p style="margin: 0; font-size: 0.9rem;">
            <strong>Vacance :</strong> 5-8% • <strong>Travaux :</strong> 3-5% du loyer annuel
          </p>
        </div>
      </p-panel>
    </div>

    <div class="results-section">
      <p-panel header="Votre cashflow" [styleClass]="'results-panel ' + getCashflowClass()">
        <div class="main-result" [ngClass]="getCashflowClass()">
          <div class="result-icon">
            <i class="pi" [ngClass]="{'pi-arrow-up': cashflowNet >= 0, 'pi-arrow-down': cashflowNet < 0}"></i>
          </div>
          <div class="result-content">
            <span class="result-value">{{ cashflowNet | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
            <span class="result-label">Cashflow net mensuel</span>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value">{{ cashflowBrut | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
            <span class="stat-label">Cashflow brut</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">{{ cashflowAnnuel | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
            <span class="stat-label">Cashflow annuel</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">{{ totalCharges | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
            <span class="stat-label">Total charges</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">{{ tauxEffort | number:'1.1-1':'fr-FR' }}%</span>
            <span class="stat-label">Taux d'effort</span>
          </div>
        </div>

        <div class="verdict" [ngClass]="getCashflowClass()" style="margin-top: 1rem;">
          <i class="pi" [ngClass]="{'pi-check-circle': cashflowNet > 0, 'pi-minus-circle': cashflowNet === 0, 'pi-exclamation-circle': cashflowNet < 0}"></i>
          <div class="verdict-text">
            <strong>{{ getVerdict() }}</strong>
            <p *ngIf="cashflowNet > 0">Votre investissement génère un surplus de {{ cashflowNet | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}/mois.</p>
            <p *ngIf="cashflowNet === 0">Les revenus locatifs couvrent exactement vos charges.</p>
            <p *ngIf="cashflowNet < 0">Effort d'épargne mensuel : {{ -cashflowNet | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</p>
          </div>
        </div>
      </p-panel>

      <p-panel header="Détail des charges mensuelles" styleClass="custom-panel" [toggleable]="true" [collapsed]="false">
        <div class="cost-breakdown">
          <div class="cost-item">
            <span class="cost-label">Mensualité crédit</span>
            <span class="cost-value">{{ mensualiteCredit | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item">
            <span class="cost-label">Charges copropriété</span>
            <span class="cost-value">{{ chargesCopro | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item">
            <span class="cost-label">Taxe foncière (mensuel)</span>
            <span class="cost-value">{{ taxeFonciere / 12 | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item">
            <span class="cost-label">Assurance PNO</span>
            <span class="cost-value">{{ assurancePNO | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item" *ngIf="fraisGestion > 0">
            <span class="cost-label">Frais de gestion</span>
            <span class="cost-value">{{ fraisGestion | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item" *ngIf="autresCharges > 0">
            <span class="cost-label">Autres charges</span>
            <span class="cost-value">{{ autresCharges | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item">
            <span class="cost-label">Provision vacance ({{ provisionVacance }}%)</span>
            <span class="cost-value">{{ provisionVacanceMontant | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item">
            <span class="cost-label">Provision travaux ({{ provisionTravaux }}%)</span>
            <span class="cost-value">{{ provisionTravauxMontant | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</span>
          </div>
          <div class="cost-item total">
            <span class="cost-label"><strong>Total mensuel</strong></span>
            <span class="cost-value"><strong>{{ mensualiteCredit + totalCharges | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</strong></span>
          </div>
        </div>

        <div class="cost-visualization" style="margin-top: 1rem;">
          <div class="cost-bar">
            <div class="cost-segment credit"
                 [style.width.%]="(mensualiteCredit / (mensualiteCredit + totalCharges)) * 100"
                 pTooltip="Crédit" tooltipPosition="top"></div>
            <div class="cost-segment charges"
                 [style.width.%]="(totalCharges / (mensualiteCredit + totalCharges)) * 100"
                 pTooltip="Charges" tooltipPosition="top"></div>
          </div>
          <div class="cost-legend">
            <span class="legend-credit"><i></i> Crédit ({{ ((mensualiteCredit / (mensualiteCredit + totalCharges)) * 100) | number:'1.0-0' }}%)</span>
            <span class="legend-charges"><i></i> Charges ({{ ((totalCharges / (mensualiteCredit + totalCharges)) * 100) | number:'1.0-0' }}%)</span>
          </div>
        </div>
      </p-panel>
    </div>
  </div>

  <section class="content-section">
    <p-panel header="Comprendre le cashflow immobilier" styleClass="custom-panel" [toggleable]="true" [collapsed]="true">
      <h3>Qu'est-ce que le cashflow ?</h3>
      <p>Le cashflow représente la différence entre vos revenus locatifs et toutes vos dépenses (crédit, charges, impôts). C'est l'indicateur clé pour évaluer si votre investissement s'autofinance.</p>

      <h3>Cashflow brut vs net</h3>
      <ul>
        <li><strong>Cashflow brut :</strong> Loyer - Mensualité crédit (vision simplifiée)</li>
        <li><strong>Cashflow net :</strong> Loyer - Crédit - Toutes charges (vision réaliste)</li>
      </ul>

      <h3>Les charges à ne pas oublier</h3>
      <ul>
        <li><strong>Charges de copropriété :</strong> Parties non récupérables sur le locataire</li>
        <li><strong>Taxe foncière :</strong> Impôt annuel à mensualiser</li>
        <li><strong>Assurance PNO :</strong> Propriétaire Non Occupant (obligatoire)</li>
        <li><strong>Provision vacance :</strong> Périodes sans locataire (5-8% recommandé)</li>
        <li><strong>Provision travaux :</strong> Entretien et réparations (3-5% recommandé)</li>
      </ul>

      <h3>Comment améliorer son cashflow ?</h3>
      <ul>
        <li>Négocier le prix d'achat pour réduire la mensualité</li>
        <li>Allonger la durée du crédit</li>
        <li>Optimiser les charges (assurance, gestion)</li>
        <li>Passer en meublé pour augmenter le loyer</li>
        <li>Renégocier le crédit si les taux baissent</li>
      </ul>
    </p-panel>
  </section>

  <app-faq-section [faqItems]="faqItems" pageTitle="Simulateur Cashflow Immobilier"></app-faq-section>
</div>
