<div class="simulateur-container">
  <section class="header-section">
    <h1>Simulateur TRI Immobilier</h1>
    <p class="subtitle">Calculez le Taux de Rentabilité Interne de votre investissement locatif</p>
    <div class="export-actions">
      <app-export-buttons [exportData]="getExportData()" [showPrint]="true"></app-export-buttons>
    </div>
  </section>

  <div class="content-grid">
    <div class="form-section">
      <p-panel header="Investissement initial" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group">
            <label>Prix d'acquisition</label>
            <p-inputNumber [(ngModel)]="investissementInitial" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
          <div class="form-group">
            <label>Frais de notaire</label>
            <p-inputNumber [(ngModel)]="fraisNotaire" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
          <div class="form-group">
            <label>Travaux</label>
            <p-inputNumber [(ngModel)]="travaux" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
        <div class="summary-row">
          <span>Investissement total :</span>
          <strong>{{ investissementTotal | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</strong>
        </div>
      </p-panel>

      <p-panel header="Revenus et charges annuels" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group">
            <label>Loyers annuels bruts</label>
            <p-inputNumber [(ngModel)]="revenusLocatifsAnnuels" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
          <div class="form-group">
            <label>Charges annuelles (copro, gestion...)</label>
            <p-inputNumber [(ngModel)]="chargesAnnuelles" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
          <div class="form-group">
            <label>Taxe foncière</label>
            <p-inputNumber [(ngModel)]="taxeFonciere" mode="currency" currency="EUR" locale="fr-FR"
                           [min]="0" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
        <div class="summary-row">
          <span>Revenus nets annuels :</span>
          <strong [class.negative]="revenusNetsAnnuels < 0">{{ revenusNetsAnnuels | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</strong>
        </div>
      </p-panel>

      <p-panel header="Hypothèses de revente" styleClass="custom-panel">
        <div class="form-grid">
          <div class="form-group">
            <label>Durée de détention</label>
            <p-inputNumber [(ngModel)]="dureeDetention" suffix=" ans"
                           [min]="1" [max]="30" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
          <div class="form-group">
            <label>Plus-value estimée à la revente</label>
            <p-inputNumber [(ngModel)]="plusValueRevente" suffix=" %"
                           [min]="-50" [max]="100" (ngModelChange)="calculer()"></p-inputNumber>
          </div>
        </div>
        <div class="summary-row">
          <span>Prix de revente estimé :</span>
          <strong>{{ prixRevente | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</strong>
        </div>
      </p-panel>
    </div>

    <div class="results-section">
      <p-panel header="Taux de Rentabilité Interne" styleClass="results-panel">
        <div class="main-result" [ngClass]="getTriClass()">
          <div class="result-icon">
            <i class="pi pi-chart-line"></i>
          </div>
          <div class="result-content">
            <span class="result-value">{{ tri !== null ? (tri | number:'1.2-2':'fr-FR') : 'N/A' }} %</span>
            <span class="result-label">TRI brut annualisé</span>
          </div>
        </div>

        <div class="verdict" [ngClass]="getTriClass()">
          <i class="pi" [ngClass]="{
            'pi-check-circle': tri !== null && tri >= 6,
            'pi-minus-circle': tri !== null && tri >= 0 && tri < 6,
            'pi-times-circle': tri !== null && tri < 0
          }"></i>
          <div class="verdict-text">
            <strong>{{ getTriVerdict() }}</strong>
            <p *ngIf="tri !== null && tri >= 6">Votre investissement génère une rentabilité supérieure aux placements classiques.</p>
            <p *ngIf="tri !== null && tri >= 0 && tri < 6">Rentabilité modeste, comparez avec d'autres opportunités.</p>
            <p *ngIf="tri !== null && tri < 0">Cet investissement génère une perte, revoyez vos paramètres.</p>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value">{{ triNet !== null ? (triNet | number:'1.2-2':'fr-FR') : 'N/A' }} %</span>
            <span class="stat-label">TRI net (après impôts)</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" [class.highlight]="van > 0" [class.negative]="van < 0">
              {{ van | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}
            </span>
            <span class="stat-label">VAN (taux 5%)</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">{{ multipleInvestissement | number:'1.2-2':'fr-FR' }}x</span>
            <span class="stat-label">Multiple d'investissement</span>
          </div>
        </div>

        <div class="help-box" style="margin-top: 1rem;">
          <h4><i class="pi pi-info-circle"></i> Interprétation du TRI</h4>
          <div class="tri-scale">
            <div class="scale-item poor">
              <span class="scale-range">&lt; 4%</span>
              <span class="scale-label">Faible</span>
            </div>
            <div class="scale-item average">
              <span class="scale-range">4-6%</span>
              <span class="scale-label">Correct</span>
            </div>
            <div class="scale-item good">
              <span class="scale-range">6-10%</span>
              <span class="scale-label">Bon</span>
            </div>
            <div class="scale-item excellent">
              <span class="scale-range">&gt; 10%</span>
              <span class="scale-label">Excellent</span>
            </div>
          </div>
        </div>
      </p-panel>

      <p-panel header="Flux de trésorerie" styleClass="custom-panel" [toggleable]="true" [collapsed]="!showDetails">
        <button class="toggle-btn" (click)="showDetails = !showDetails">
          {{ showDetails ? 'Masquer' : 'Afficher' }} le détail des flux
        </button>

        <div class="cashflow-table" *ngIf="showDetails">
          <table>
            <thead>
              <tr>
                <th>Année</th>
                <th>Flux de trésorerie</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              <tr class="negative">
                <td>0</td>
                <td>{{ -investissementTotal | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</td>
                <td>Investissement initial</td>
              </tr>
              <tr *ngFor="let flux of cashFlowsAnnuels; let i = index">
                <td>{{ i + 1 }}</td>
                <td [class.positive]="flux > 0">{{ flux | currency:'EUR':'symbol':'1.0-0':'fr-FR' }}</td>
                <td>{{ i === cashFlowsAnnuels.length - 1 ? 'Revenus + Revente' : 'Revenus nets' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </p-panel>
    </div>
  </div>

  <section class="content-section">
    <p-panel header="Comprendre le TRI immobilier" styleClass="custom-panel" [toggleable]="true" [collapsed]="true">
      <h3>Qu'est-ce que le TRI ?</h3>
      <p>Le TRI (Taux de Rentabilité Interne) est le taux d'actualisation qui rend la Valeur Actuelle Nette (VAN) d'un investissement égale à zéro. C'est le rendement annualisé réel de votre investissement, tenant compte de tous les flux de trésorerie dans le temps.</p>

      <h3>Pourquoi utiliser le TRI plutôt que le rendement locatif ?</h3>
      <ul>
        <li><strong>Vision globale :</strong> Le TRI intègre l'investissement initial, les loyers, les charges, et la revente</li>
        <li><strong>Facteur temps :</strong> Il prend en compte quand les flux arrivent (un euro aujourd'hui vaut plus qu'un euro demain)</li>
        <li><strong>Comparabilité :</strong> Permet de comparer des investissements avec des durées et structures différentes</li>
      </ul>

      <h3>Comment interpréter le résultat ?</h3>
      <ul>
        <li>Comparez le TRI au taux de votre crédit : si TRI > taux du crédit, l'effet de levier est positif</li>
        <li>Comparez au rendement d'autres placements (Livret A, assurance-vie, bourse)</li>
        <li>Un TRI de 8% signifie que votre capital fructifie de 8% par an en moyenne</li>
      </ul>

      <h3>Limites du TRI</h3>
      <ul>
        <li>Suppose un réinvestissement des flux au même taux (hypothèse optimiste)</li>
        <li>Ne tient pas compte du risque ou de la liquidité</li>
        <li>Sensible aux hypothèses de plus-value à la revente</li>
      </ul>
    </p-panel>
  </section>

  <app-faq-section [faqItems]="faqItems" pageTitle="Simulateur TRI Immobilier"></app-faq-section>
</div>
