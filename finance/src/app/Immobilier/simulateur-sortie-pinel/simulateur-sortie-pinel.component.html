<div class="simulateur-container">
  <div class="header-section">
    <h1>Simulateur Sortie Pinel : Vendre, LMNP ou Location Nue ?</h1>
    <p class="subtitle">Comparez les 3 options à la fin de votre engagement Pinel et trouvez la plus rentable</p>
  </div>

  <div class="intro-text">
    <p>
      La fin de l'engagement Pinel est une étape clé pour tout investisseur immobilier.
      À l'issue des 6, 9 ou 12 années de location à loyer plafonné, la réduction d'impôt cesse
      et le bien entre dans une nouvelle phase de rentabilité.
    </p>
  </div>

  <div class="form-section-top">
    <p-panel header="Informations sur votre bien Pinel" styleClass="custom-panel">
      <div class="form-grid-4">
        <div class="form-group">
          <label for="prixAchat">Prix d'achat initial</label>
          <p-inputNumber
            id="prixAchat"
            [(ngModel)]="prixAchat"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="valeurActuelle">Valeur actuelle estimée</label>
          <p-inputNumber
            id="valeurActuelle"
            [(ngModel)]="valeurActuelle"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="duree">Durée d'engagement Pinel</label>
          <p-dropdown
            id="duree"
            [options]="dureeEngagement"
            [(ngModel)]="selectedDuree"
            styleClass="w-full">
          </p-dropdown>
        </div>

        <div class="form-group">
          <label for="tmi">Votre TMI (Tranche Marginale)</label>
          <p-dropdown
            id="tmi"
            [options]="tmi"
            [(ngModel)]="selectedTMI"
            styleClass="w-full">
          </p-dropdown>
        </div>
      </div>
    </p-panel>

    <p-panel header="Revenus locatifs" styleClass="custom-panel">
      <div class="form-grid-4">
        <div class="form-group">
          <label for="loyerPinel">Loyer mensuel Pinel actuel</label>
          <p-inputNumber
            id="loyerPinel"
            [(ngModel)]="loyerMensuelPinel"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="loyerMarche">Loyer marché estimé (hors Pinel)</label>
          <p-inputNumber
            id="loyerMarche"
            [(ngModel)]="loyerMarcheEstime"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="charges">Charges annuelles</label>
          <p-inputNumber
            id="charges"
            [(ngModel)]="chargesAnnuelles"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="taxeFonciere">Taxe foncière</label>
          <p-inputNumber
            id="taxeFonciere"
            [(ngModel)]="taxeFonciere"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>
      </div>
    </p-panel>

    <p-panel header="Crédit immobilier (optionnel)" styleClass="custom-panel">
      <div class="form-grid-3">
        <div class="form-group">
          <label for="capitalRestant">Capital restant dû</label>
          <p-inputNumber
            id="capitalRestant"
            [(ngModel)]="capitalRestantDu"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="mensualite">Mensualité crédit</label>
          <p-inputNumber
            id="mensualite"
            [(ngModel)]="mensualiteCredit"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="form-group">
          <label for="fraisVente">Frais de vente estimés</label>
          <p-inputNumber
            id="fraisVente"
            [(ngModel)]="fraisVente"
            mode="currency"
            currency="EUR"
            locale="fr-FR"
            [min]="0">
          </p-inputNumber>
        </div>
      </div>
    </p-panel>

    <div class="action-bar">
      <button pButton type="button" label="Comparer les 3 options" icon="pi pi-calculator" class="p-button-success p-button-lg" (click)="calculer()"
        [disabled]="!prixAchat || !valeurActuelle || !loyerMensuelPinel || !loyerMarcheEstime || selectedTMI === null">
      </button>
    </div>
  </div>

  <!-- Résultats -->
  <div *ngIf="resultats" class="results-section">
    <h2>Comparaison des 3 options après la fin du Pinel</h2>

    <div class="options-grid">
      <!-- Option 1: Vendre -->
      <div class="option-card vente" [class.best-option]="meilleurOption === 'vente'">
        <div class="card-header">
          <h3><i class="pi pi-tag"></i> Vendre le bien</h3>
          <span class="badge-best" *ngIf="meilleurOption === 'vente'">Meilleure option</span>
        </div>
        <div class="card-content">
          <div class="section-title">Calcul de la vente</div>
          <div class="detail-row">
            <span>Valeur actuelle</span>
            <span>{{ resultats.vente.netVente + (capitalRestantDu || 0) + (fraisVente || resultats.vente.netVente * 0.07) | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row">
            <span>Capital restant dû</span>
            <span class="negative">- {{ capitalRestantDu || 0 | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row">
            <span>Frais de vente (~7%)</span>
            <span class="negative">- {{ fraisVente || (valeurActuelle || 0) * 0.07 | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Net de vente</span>
            <span>{{ resultats.vente.netVente | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="section-title">Plus-value immobilière</div>
          <div class="detail-row">
            <span>Plus-value brute</span>
            <span>{{ resultats.vente.plusValue | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row">
            <span>Impôt sur plus-value (36,2%)</span>
            <span class="negative">- {{ resultats.vente.impotPlusValue | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Net après fiscalité</span>
            <span>{{ resultats.vente.netApresFiscalite | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="total-row">
            <span>Rendement si réinvesti à 4%</span>
            <span>{{ resultats.vente.rendementReinvest | currency:'EUR':'symbol':'1.0-0':'fr' }}/an</span>
          </div>
        </div>
      </div>

      <!-- Option 2: Location Nue -->
      <div class="option-card location-nue" [class.best-option]="meilleurOption === 'locationNue'">
        <div class="card-header">
          <h3><i class="pi pi-home"></i> Location nue classique</h3>
          <span class="badge-best" *ngIf="meilleurOption === 'locationNue'">Meilleure option</span>
        </div>
        <div class="card-content">
          <div class="section-title">Revenus fonciers</div>
          <div class="detail-row">
            <span>Loyer annuel marché</span>
            <span>{{ resultats.locationNue.loyerAnnuel | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row">
            <span>Charges + Taxe foncière</span>
            <span class="negative">- {{ (chargesAnnuelles || 0) + (taxeFonciere || 0) | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Revenu foncier brut</span>
            <span>{{ resultats.locationNue.revenuFoncierBrut | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="section-title">Fiscalité (TMI + PS 17,2%)</div>
          <div class="detail-row">
            <span>Impôts sur revenus fonciers</span>
            <span class="negative">- {{ resultats.locationNue.impots | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Revenu net après impôts</span>
            <span>{{ resultats.locationNue.revenuNet | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="section-title">Cashflow</div>
          <div class="detail-row">
            <span>Mensualités crédit</span>
            <span class="negative">- {{ (mensualiteCredit || 0) * 12 | currency:'EUR':'symbol':'1.0-0':'fr' }}/an</span>
          </div>

          <div class="total-row">
            <span>Cashflow annuel</span>
            <span>{{ resultats.locationNue.cashflow | currency:'EUR':'symbol':'1.0-0':'fr' }}/an</span>
          </div>
          <div class="rendement-row">
            <span>Rendement net : {{ resultats.locationNue.rendement | number:'1.1-1':'fr' }}%</span>
          </div>
        </div>
      </div>

      <!-- Option 3: LMNP -->
      <div class="option-card lmnp" [class.best-option]="meilleurOption === 'lmnp'">
        <div class="card-header">
          <h3><i class="pi pi-building"></i> Passage en LMNP</h3>
          <span class="badge-best" *ngIf="meilleurOption === 'lmnp'">Meilleure option</span>
        </div>
        <div class="card-content">
          <div class="section-title">Revenus meublé (+15%)</div>
          <div class="detail-row">
            <span>Loyer meublé annuel</span>
            <span>{{ resultats.lmnp.loyerMeuble | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row">
            <span>Charges + Taxe foncière</span>
            <span class="negative">- {{ ((chargesAnnuelles || 0) * 1.1) + (taxeFonciere || 0) | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="section-title">Avantage amortissement</div>
          <div class="detail-row">
            <span>Amortissement déductible</span>
            <span class="positive">- {{ resultats.lmnp.amortissement | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Résultat BIC imposable</span>
            <span>{{ resultats.lmnp.resultatBIC | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="section-title">Fiscalité BIC</div>
          <div class="detail-row">
            <span>Impôts (TMI + PS)</span>
            <span class="negative">- {{ resultats.lmnp.impots | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>
          <div class="detail-row highlight">
            <span>Revenu net après impôts</span>
            <span>{{ resultats.lmnp.revenuNet | currency:'EUR':'symbol':'1.0-0':'fr' }}</span>
          </div>

          <div class="total-row">
            <span>Cashflow annuel</span>
            <span>{{ resultats.lmnp.cashflow | currency:'EUR':'symbol':'1.0-0':'fr' }}/an</span>
          </div>
          <div class="rendement-row">
            <span>Rendement net : {{ resultats.lmnp.rendement | number:'1.1-1':'fr' }}%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Verdict -->
    <div class="verdict-section">
      <div class="verdict" [ngClass]="meilleurOption">
        <div class="verdict-icon">
          <i class="pi pi-trophy"></i>
        </div>
        <div class="verdict-content">
          <span class="verdict-label">Option recommandée</span>
          <span class="verdict-value">
            <ng-container [ngSwitch]="meilleurOption">
              <span *ngSwitchCase="'vente'">Vendre et réinvestir</span>
              <span *ngSwitchCase="'locationNue'">Continuer en location nue</span>
              <span *ngSwitchCase="'lmnp'">Passer en LMNP</span>
            </ng-container>
          </span>
          <span class="verdict-detail">
            <ng-container [ngSwitch]="meilleurOption">
              <span *ngSwitchCase="'vente'">
                Avec un rendement estimé de {{ resultats.vente.rendementReinvest | currency:'EUR':'symbol':'1.0-0':'fr' }}/an si réinvesti à 4%
              </span>
              <span *ngSwitchCase="'locationNue'">
                Rendement net de {{ resultats.locationNue.rendement | number:'1.1-1':'fr' }}% avec un cashflow de {{ resultats.locationNue.cashflow | currency:'EUR':'symbol':'1.0-0':'fr' }}/an
              </span>
              <span *ngSwitchCase="'lmnp'">
                Rendement net de {{ resultats.lmnp.rendement | number:'1.1-1':'fr' }}% grâce à l'amortissement fiscal LMNP
              </span>
            </ng-container>
          </span>
        </div>
      </div>
    </div>

    <!-- Conseils -->
    <div class="tips-grid">
      <div class="tip-card warning">
        <i class="pi pi-exclamation-triangle"></i>
        <h4>Vente anticipée</h4>
        <p>Si vous vendez avant la fin de l'engagement, vous devrez rembourser les réductions d'impôt Pinel obtenues.</p>
      </div>
      <div class="tip-card info">
        <i class="pi pi-info-circle"></i>
        <h4>LMNP après Pinel</h4>
        <p>Le passage en LMNP permet de bénéficier de l'amortissement comptable et réduit fortement l'imposition.</p>
      </div>
      <div class="tip-card success">
        <i class="pi pi-check-circle"></i>
        <h4>Loyer déplafonné</h4>
        <p>Après le Pinel, vous pouvez augmenter le loyer au prix du marché, ce qui améliore la rentabilité.</p>
      </div>
    </div>
  </div>

  <!-- Section explicative -->
  <section class="info-section">
    <h2>Comprendre la sortie du dispositif Pinel</h2>

    <div class="info-grid">
      <div class="info-card">
        <h3><i class="pi pi-calendar"></i> Calendrier Pinel</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Durée</th>
              <th>Réduction totale</th>
              <th>Options après</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>6 ans</td>
              <td>12%</td>
              <td>Vente, location nue ou LMNP</td>
            </tr>
            <tr>
              <td>9 ans</td>
              <td>18%</td>
              <td>Vente, location nue ou LMNP</td>
            </tr>
            <tr>
              <td>12 ans</td>
              <td>21%</td>
              <td>Vente, location nue ou LMNP</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="info-card">
        <h3><i class="pi pi-exclamation-circle"></i> Erreurs à éviter</h3>
        <ul class="check-list error">
          <li>Vendre avant la fin de l'engagement fiscal</li>
          <li>Passer en LMNP sans anticiper la fiscalité à la revente</li>
          <li>Ignorer l'impact du crédit restant sur le cashflow</li>
          <li>Sous-estimer la fiscalité des revenus fonciers</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <app-faq-section
    [title]="'FAQ – Questions sur la sortie du Pinel'"
    [faqItems]="faqItems"
    [ariaLabel]="'Foire aux questions sortie Pinel'">
  </app-faq-section>
</div>
